<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloudflare Statistics</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Enable dark mode based on system preference
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  </script>
  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center font-sans">
  <div class="max-w-5xl w-full p-4 space-y-6">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold text-gray-800 dark:text-gray-100">DSTAT EUIS</h1>
      <span class="px-4 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium">Premium Statistics</span>
      <span id="right-text" class="text-gray-600 dark:text-gray-300"></span>
      <span id="date-text" class="text-gray-600 dark:text-gray-300"></span>
    </div>
    <!-- Charts -->
    <div class="flex flex-col lg:flex-row lg:space-x-4 space-y-4 lg:space-y-0">
      <div id="container-pie" class="bg-white dark:bg-gray-800 rounded-xl shadow-md flex-1 p-4"></div>
      <div id="container-bar" class="bg-white dark:bg-gray-800 rounded-xl shadow-md flex-1 p-4"></div>
    </div>
    <!-- Tables -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <table id="table-1" class="w-full table-auto text-left text-sm text-gray-700 dark:text-gray-300">
          <thead class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">
            <tr><th class="px-3 py-2">#</th><th class="px-3 py-2">ASN</th><th class="px-3 py-2">Count</th></tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
        </table>
        <table id="table-2" class="w-full table-auto text-left text-sm text-gray-700 dark:text-gray-300">
          <thead class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">
            <tr><th class="px-3 py-2">#</th><th class="px-3 py-2">ASN</th><th class="px-3 py-2">Count</th></tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Original Scripts (unchanged) -->
  <script>
    async function loadASNData() {
      try {
        const response = await fetch('asn_data.json');
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error loading ASN data:', error);
        return [];
      }
    }

    async function getISPName(asnCode, asnData) {
      const asnEntry = asnData.find(entry => entry.ASN === `AS${asnCode}`);
      return asnEntry ? asnEntry["AS Name"] : 'Unknown ISP';
    }

    function formatCount(count) {
      if (count >= 1e9) return (count / 1e9).toFixed(1) + 'B';
      if (count >= 1e6) return (count / 1e6).toFixed(1) + 'M';
      if (count >= 1e3) return (count / 1e3).toFixed(1) + 'K';
      return count;
    }

    async function updateTable() {
      const params = new URLSearchParams(window.location.search);
      const asnParam = params.get('asn');
      const asnDataParam = asnParam ? asnParam.slice(1, -1).split(',') : ['AS0000-0'];

      const asnData = await loadASNData();

      const tableData = await Promise.all(asnDataParam.map(async entry => {
        const [asnCode, countStr] = entry.split('-');
        const count = parseFloat(countStr);
        const ispName = await getISPName(asnCode, asnData);
        return { name: ispName, count: count, formattedCount: formatCount(count) };
      }));

      const maxRows = 10;
      while (tableData.length < maxRows) {
        tableData.push({ name: '?', count: 0, formattedCount: '?' });
      }

      tableData.sort((a, b) => b.count - a.count);

      const tables = [
        document.querySelector('#table-1 tbody'),
        document.querySelector('#table-2 tbody')
      ];

      tableData.forEach((item, index) => {
        const table = tables[Math.floor(index / 5)];
        const row = document.createElement('tr');
        row.innerHTML = `<td class='px-3 py-2'>${index + 1}</td><td class='px-3 py-2'>${item.name}</td><td class='px-3 py-2'>${item.formattedCount}</td>`;
        table.appendChild(row);
      });
    }

    updateTable();

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param) || 'NULL';
    }

    function getSeriesData() {
      const ovrParam = getQueryParam('ovr');
      if (ovrParam === 'NULL') {
        return [{ name: 'NULL', y: 100 }];
      }

      function translateSource(source) {
        if (source.startsWith('firewallCustom')) return 'Custom Rules';
        if (source.startsWith('m')) return 'Managed Ruleset';
        if (source.startsWith('s')) return 'Security Level';
        if (source.startsWith('r')) return 'Rate Limit';
        if (source.startsWith('l7')) return 'HTTP DDoS';
        if (source.startsWith('bic')) return 'Browser Integrity Check';
        if (source.startsWith('botFight')) return 'Bot Fight Mode';
        if (source.startsWith('firewallManaged')) return 'Managed Rules';
        if (source.startsWith('pass')) return 'Successful';
        return source;
      }

      const sources = ovrParam.slice(1, -1).split(',');
      const seriesData = sources.map(source => {
        const [sourceKey, value] = source.split('-');
        return { name: translateSource(sourceKey), y: parseFloat(value) };
      });

      return seriesData;
    }

    function getNationData() {
      const nationParam = getQueryParam('nation');
      if (nationParam === 'NULL') {
        return [{ name: 'NULL', y: 100 }];
      }

      const nationCodes = nationParam.slice(1, -1).split(',');
      const promises = nationCodes.map(async (code) => {
        const [countryCode, count] = code.split('-');
        try {
          const response = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`);
          const data = await response.json();
          const countryName = data[0].name.common;
          return { name: countryName || countryCode, y: parseFloat(count) };
        } catch {
          return { name: countryCode, y: parseFloat(count) };
        }
      });

      return Promise.all(promises).then(results => {
        results.sort((a, b) => b.y - a.y);
        return results;
      }).catch(() => [{ name: 'NULL', y: 100 }]);
    }

    document.getElementById('right-text').textContent = getQueryParam('sv');
    document.getElementById('date-text').textContent = getQueryParam('date');

    Highcharts.chart('container-pie', {
      chart: {
        type: 'pie',
        backgroundColor: 'rgba(0, 0, 0, 0)',
        height: 295,
        width: 240
      },
      tooltip: { pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>' },
      title: { text: 'Overall', style: { fontFamily: 'Avenir, monospace', fontSize: '22px', fontWeight: 'bold' } },
      legend: { enabled: true, layout: 'horizontal', itemStyle: { fontFamily: 'Courier Prime, monospace', fontSize: '12px' }, labelFormatter: function() { return this.name + ' (' + this.percentage.toFixed(1) + '%)'; } },
      plotOptions: { pie: { borderWidth: 2, dataLabels: { enabled: false } }, series: { allowPointSelect: true, cursor: 'pointer', borderRadius: 2, borderWidth: 2, animation: false, showInLegend: true } },
      series: [{ name: 'Source', colorByPoint: true, data: getSeriesData() }],
      credits: { enabled: false }
    });

    getNationData().then(data => {
      Highcharts.chart('container-bar', {
        chart: { type: 'bar', backgroundColor: 'rgba(0, 0, 0, 0)' },
        title: { text: "Top Nation's IP", style: { fontFamily: 'Avenir, monospace', fontSize: '22px' } },
        xAxis: { categories: data.map(d => d.name), title: { text: null }, labels: { formatter: function () { let label = this.value; return label.length > 16 ? label.substring(0, 8) + 'â€¦' : label; }, style: { fontFamily: 'Courier Prime, monospace' } } },
        yAxis: { min: 0, title: { text: null }, labels: { style: { fontFamily: 'Courier Prime, monospace' } }, gridLineDashStyle: 'Dash' },
        tooltip: { valueSuffix: ' counts', style: { fontFamily: 'Courier Prime, monospace' } },
        plotOptions: { bar: { dataLabels: { enabled: true, align: 'center', format: '{y}', style: { fontSize: '13px', fontFamily: 'Courier Prime, monospace' } }, animation: false } },
        legend: { enabled: false },
        series: [{ name: 'Count', data: data.map(d => d.y) }],
        credits: { enabled: false }
      });
    });
  </script>
</body>
</html>
