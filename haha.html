<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cloudflare Stats</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap');

    body {
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
      font-family: 'Segoe UI', sans-serif;
      color: #222;
    }

    .card {
      max-width: 1000px;
      margin: auto;
      background-color: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .header {
      background-color: #122c55;
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header .left h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    .header .left h2 {
      margin: 0;
      font-size: 16px;
      color: #81c1ff;
    }

    .header .right {
      text-align: right;
    }

    .header .right div {
      font-size: 16px;
    }

    .header .right span {
      font-size: 14px;
      color: #ccc;
    }

    .charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 30px;
    }

    .chart-box {
      background-color: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .chart-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .tables {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 0 30px 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      font-size: 14px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px dashed #ccc;
      text-align: left;
    }

    th {
      background-color: #f5f5f5;
      font-weight: 600;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="left">
        <h2>DSTAT EUIS</h2>
        <h1>Premium Statistics</h1>
      </div>
      <div class="right">
        <div id="right-text">Cloudflare-Pro</div>
        <span id="date-text">--/--/----</span>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box">
        <h3>Overall Sources</h3>
        <div id="container-pie" style="height: 250px;"></div>
      </div>
      <div class="chart-box">
        <h3>Top Nation's IP</h3>
        <div id="container-bar" style="height: 250px;"></div>
      </div>
    </div>

    <div class="tables">
      <table id="table-1">
        <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
      <table id="table-2">
        <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
   async function loadASNData() {
            try {
                const response = await fetch('asn_data.json');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error loading ASN data:', error);
                return [];
            }
        }

   async function getISPName(asnCode, asnData) {
            const asnEntry = asnData.find(entry => entry.ASN === `AS${asnCode}`);
            return asnEntry ? asnEntry["AS Name"] : 'Unknown ISP';
        }

    function formatCount(count) {
      if (count >= 1e9) return (count / 1e9).toFixed(1) + 'B';
      if (count >= 1e6) return (count / 1e6).toFixed(1) + 'M';
      if (count >= 1e3) return (count / 1e3).toFixed(1) + 'K';
      return count;
    }

    async function updateTable() {
            const params = new URLSearchParams(window.location.search);
            const asnParam = params.get('asn');
            const asnDataParam = asnParam ? asnParam.slice(1, -1).split(',') : ['AS0000-0'];

            const asnData = await loadASNData();

            const tableData = await Promise.all(asnDataParam.map(async entry => {
                const [asnCode, countStr] = entry.split('-');
                const count = parseFloat(countStr);
                const ispName = await getISPName(asnCode, asnData);
                return { name: ispName, count: count, formattedCount: formatCount(count) };
            }));

            const maxRows = 10;
            while (tableData.length < maxRows) {
                tableData.push({ name: '?', count: 0, formattedCount: '?' });
            }

            tableData.sort((a, b) => b.count - a.count);

            const tables = [
                document.querySelector('#table-1 tbody'),
                document.querySelector('#table-2 tbody')
            ];

            tableData.forEach((item, index) => {
                const table = tables[Math.floor(index / 5)];
                const row = document.createElement('tr');
                row.innerHTML = `<td>${index + 1}</td><td>${item.name}</td><td>${item.formattedCount}</td>`;
                table.appendChild(row);
            });
        }

        updateTable();



    function getQueryParam(key) {
      const params = new URLSearchParams(location.search);
      return params.get(key) || 'NULL';
    }

    function getSeriesData() {
      const ovr = getQueryParam('ovr');
      if (ovr === 'NULL') return [{ name: 'NULL', y: 100 }];

      function translateSource(source) {
                if (source.startsWith('firewallCustom')) return 'Custom Rules';
                if (source.startsWith('m')) return 'Managed Ruleset';
                if (source.startsWith('s')) return 'Security Level';
                if (source.startsWith('r')) return 'Rate Limit';
                if (source.startsWith('l7')) return 'HTTP DDoS';
                if (source.startsWith('bic')) return 'Browser Integrity Check';
                if (source.startsWith('botFight')) return 'Bot Fight Mode';
                if (source.startsWith('firewallManaged')) return 'Managed Rules';
                if (source.startsWith('pass')) return 'Successful';
                return source;
            }


            const sources = ovrParam.slice(1, -1).split(',');
            const seriesData = sources.map(source => {
                const [sourceKey, value] = source.split('-');
                return { name: translateSource(sourceKey), y: parseFloat(value) }; // Chuyển đổi value thành số thực
            });

            return seriesData;
        }

   function getNationData() {
            const nationParam = getQueryParam('nation');
            if (nationParam === 'NULL') {
                return [{ name: 'NULL', y: 100 }];
            }

            const nationCodes = nationParam.slice(1, -1).split(',');
            const promises = nationCodes.map(async (code) => {
                const [countryCode, count] = code.split('-');
                try {
                    const response = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`);
                    const data = await response.json();
                    const countryName = data[0].name.common;
                    return { name: countryName || countryCode, y: parseFloat(count) };
                } catch {
                    return { name: countryCode, y: parseFloat(count) };
                }
            });

      return data.sort((a, b) => b.y - a.y);
    }

    document.getElementById('right-text').textContent = getQueryParam('sv');
    document.getElementById('date-text').textContent = getQueryParam('date');

    Highcharts.chart('container-pie', {
      chart: {
        type: 'pie',
        backgroundColor: 'transparent'
      },
      title: { text: '' },
      plotOptions: {
        pie: {
          innerSize: '60%',
          dataLabels: {
            enabled: true,
            format: '{point.name}: {point.percentage:.1f}%'
          }
        }
      },
      series: [{
        name: 'Sources',
        data: getSeriesData(),
        colors: Highcharts.getOptions().colors.map((c, i) =>
          Highcharts.color(c).brighten(i * 0.05).get()
        )
      }],
      credits: { enabled: false }
    });

    getNationData().then(data => {
      Highcharts.chart('container-bar', {
        chart: { type: 'column', backgroundColor: 'transparent' },
        title: { text: '' },
        xAxis: {
          categories: data.map(d => d.name),
          crosshair: true
        },
        yAxis: {
          min: 0,
          title: { text: 'Counts' }
        },
        tooltip: {
          shared: true,
          useHTML: true,
          headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
          pointFormat:
            '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
            '<td style="padding:0"><b>{point.y}</b></td></tr>',
          footerFormat: '</table>'
        },
        plotOptions: {
          column: {
            borderRadius: 5,
            dataLabels: { enabled: true }
          }
        },
        series: [{ name: 'IP Count', data: data }],
        credits: { enabled: false }
      });
    });

    updateTable();
  </script>
</body>
</html>
