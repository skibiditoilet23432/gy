<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Premium Statistics</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #F4F6F8;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Courier Prime', monospace;
    }

    .dashboard {
      width: 720px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #243B63 0%, #1C2C5B 100%);
      color: #fff;
      padding: 16px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand .logo {
      font-size: 13px;
      color: #6CA0DC;
    }

    .brand .title {
      font-size: 22px;
      margin-top: 2px;
    }

    .meta {
      font-size: 13px;
      text-align: right;
    }

    .content {
      padding: 0 22px 22px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 14px;
      margin-top: -10px;
    }

    .card {
      background-color: #fff;
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
    }

    .card h3 {
      font-size: 15px;
      margin-bottom: 8px;
      color: #1C2C5B;
    }

    .charts .card {
      height: 240px;
    }

    #container-pie, #container-bar {
      height: calc(100% - 26px);
    }

    .tables {
      grid-column: 1 / span 2;
      display: flex;
      gap: 14px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }

    th, td {
      padding: 6px 4px;
      border-bottom: 1px dashed #CCC;
      text-align: left;
    }

    td:last-child, th:last-child {
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <div class="brand">
        <span class="logo">AIKO</span>
        <span class="title">Premium Statistics</span>
      </div>
      <div class="meta">
        <div id="server-text">CloudflareEntreprise</div>
        <div id="date-text">Aug 18, 2024</div>
      </div>
    </div>
    <div class="content">
      <div class="card charts">
        <h3>Overall</h3>
        <div id="container-pie"></div>
      </div>
      <div class="card charts">
        <h3>Top Nation's IP</h3>
        <div id="container-bar"></div>
      </div>
      <div class="tables">
        <div class="card">
          <table id="table-1">
            <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <table id="table-2">
            <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    function parsePythonList(param) {
      if (!param || param === 'NULL') return [];
      return param.slice(1, -1).split(',').map(x => x.trim().replace(/^['"]|['"]$/g, ''));
    }

    const urlParams = new URLSearchParams(window.location.search);
    const sv = urlParams.get('sv') || 'NULL';
    const date = urlParams.get('date') || 'NULL';
    document.getElementById('server-text').textContent = sv;
    document.getElementById('date-text').textContent = date;

    function getSeriesData() {
      const raw = parsePythonList(urlParams.get('ovr'));
      const colorMap = {
        'Managed Ruleset': '#1f77b4',
        'HTTP DDoS': '#ff7f0e',
        'Successful': '#2ca02c',
        'Security Level': '#17becf',
        'Custom Rules': '#ffcd00'
      };
      return raw.map(source => {
        const [key, val] = source.split('-');
        const nameMap = {
          m: 'Managed Ruleset',
          s: 'Security Level',
          l7: 'HTTP DDoS',
          pass: 'Successful',
          firewallCustom: 'Custom Rules'
        };
        const prefix = Object.keys(nameMap).find(p => key.startsWith(p)) || key;
        const name = nameMap[prefix] || key;
        return { name, y: parseFloat(val), color: colorMap[name] };
      });
    }

    async function getNationData() {
      const raw = parsePythonList(urlParams.get('nation'));
      const data = await Promise.all(raw.map(async entry => {
        const [code, count] = entry.split('-');
        try {
          const res = await fetch(`https://restcountries.com/v3.1/alpha/${code}`);
          const json = await res.json();
          const name = json[0]?.name?.common || code;
          return { name, y: parseFloat(count) };
        } catch {
          return { name: code, y: parseFloat(count) };
        }
      }));
      return data.sort((a, b) => b.y - a.y);
    }

    function getASNData() {
      const raw = parsePythonList(urlParams.get('asn'));
      return raw.map(entry => {
        const [asnCode, count] = entry.replace(/^AS/, '').split('-');
        return { name: 'AS' + asnCode, count: parseInt(count) };
      });
    }

    Highcharts.chart('container-pie', {
      chart: { type: 'pie', backgroundColor: '#fff' },
      title: { text: null },
      plotOptions: {
        pie: {
          allowPointSelect: true,
          cursor: 'pointer',
          borderColor: '#fff',
          dataLabels: {
            enabled: true,
            format: '{point.y}%',
            style: { fontSize: '12px', color: '#fff', textOutline: '0px' },
            distance: -30
          }
        }
      },
      series: [{
        name: 'Overall',
        colorByPoint: true,
        data: getSeriesData()
      }],
      credits: { enabled: false }
    });

    getNationData().then(data => {
      Highcharts.chart('container-bar', {
        chart: { type: 'bar', backgroundColor: '#fff' },
        title: { text: null },
        xAxis: {
          categories: data.map(d => d.name),
          labels: { style: { fontSize: '12px', color: '#1C2C5B' } }
        },
        yAxis: {
          min: 0,
          gridLineDashStyle: 'Dash',
          labels: { style: { fontSize: '11px', color: '#1C2C5B' } },
          title: { text: null }
        },
        plotOptions: {
          bar: {
            dataLabels: {
              enabled: true,
              format: '{point.y}',
              style: { fontSize: '11px', color: '#1C2C5B', textOutline: '0px' }
            }
          }
        },
        series: [{ name: 'Count', data: data.map(d => d.y), color: '#3C8DBC' }],
        legend: { enabled: false },
        credits: { enabled: false }
      });
    });

    const asn = getASNData();
    const left = document.querySelector('#table-1 tbody');
    const right = document.querySelector('#table-2 tbody');
    asn.forEach((item, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i + 1}</td><td>${item.name}</td><td>${item.count.toLocaleString()}</td>`;
      (i < 5 ? left : right).appendChild(tr);
    });
  </script>
</body>
</html>
