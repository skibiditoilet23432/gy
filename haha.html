<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Statistics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-6">

    <!-- Profile Card -->
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-2xl p-4 mb-6 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="w-14 h-14 bg-gray-300 rounded-full flex items-center justify-center text-xl text-white">
                <span>ðŸ‘¤</span>
            </div>
            <div>
                <h2 class="font-bold text-lg" id="profile-name">NULL</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400" id="profile-username">@NULL</p>
            </div>
        </div>
        <div class="text-sm text-gray-600 dark:text-gray-300">
            <span>Telegram UID: </span><span id="telegram-uid">NULL</span>
        </div>
    </div>

    <!-- Request Summary Card -->
    <div class="bg-gradient-to-r from-purple-100 via-white to-indigo-100 dark:from-indigo-700 dark:via-gray-800 dark:to-purple-700 p-6 rounded-2xl shadow mb-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">Total Requests</p>
                <p class="text-2xl font-bold text-blue-600 dark:text-white" id="total-requests">NULL</p>
            </div>
            <div class="flex-grow ml-6">
                <div class="w-full bg-gray-300 dark:bg-gray-700 h-3 rounded-full overflow-hidden">
                    <div class="h-3 bg-green-500" id="progress-allowed" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs mt-1 text-gray-500 dark:text-gray-300">
                    <span class="text-green-600 dark:text-green-400">Allowed</span>
                    <span class="text-blue-600 dark:text-blue-400">Bypassed</span>
                    <span class="text-red-600 dark:text-red-400">Blocked</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Info -->
    <div class="mb-6 flex justify-between">
        <span class="text-lg font-semibold">Server: <span id="right-text">NULL</span></span>
        <span class="text-lg font-semibold">Date: <span id="date-text">NULL</span></span>
    </div>

    <!-- Chart Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
            <div id="container-pie" class="w-full h-72"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
            <div id="container-bar" class="w-full h-72"></div>
        </div>
    </div>

    <!-- Tables -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <table id="table-1" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">ISP</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">Count</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600"></tbody>
        </table>

        <table id="table-2" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">ISP</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">Count</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600"></tbody>
        </table>
    </div>

    <!-- Your Preserved Script -->
    <script>
        async function loadASNData() {
            try {
                const response = await fetch('asn_data.json');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error loading ASN data:', error);
                return [];
            }
        }

        async function getISPName(asnCode, asnData) {
            const asnEntry = asnData.find(entry => entry.ASN === `AS${asnCode}`);
            return asnEntry ? asnEntry["AS Name"] : 'Unknown ISP';
        }

        function formatCount(count) {
            if (count >= 1e9) return (count / 1e9).toFixed(1) + 'B';
            if (count >= 1e6) return (count / 1e6).toFixed(1) + 'M';
            if (count >= 1e3) return (count / 1e3).toFixed(1) + 'K';
            return count;
        }

        async function updateTable() {
            const params = new URLSearchParams(window.location.search);
            const asnParam = params.get('asn');
            const asnDataParam = asnParam ? asnParam.slice(1, -1).split(',') : ['AS0000-0'];

            const asnData = await loadASNData();

            const tableData = await Promise.all(asnDataParam.map(async entry => {
                const [asnCode, countStr] = entry.split('-');
                const count = parseFloat(countStr);
                const ispName = await getISPName(asnCode, asnData);
                return { name: ispName, count: count, formattedCount: formatCount(count) };
            }));

            const maxRows = 10;
            while (tableData.length < maxRows) {
                tableData.push({ name: '?', count: 0, formattedCount: '?' });
            }

            tableData.sort((a, b) => b.count - a.count);

            const tables = [
                document.querySelector('#table-1 tbody'),
                document.querySelector('#table-2 tbody')
            ];

            tableData.forEach((item, index) => {
                const table = tables[Math.floor(index / 5)];
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-4 py-2">${index + 1}</td><td class="px-4 py-2">${item.name}</td><td class="px-4 py-2">${item.formattedCount}</td>`;
                table.appendChild(row);
            });
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param) || 'NULL';
        }

        function getSeriesData() {
            const ovrParam = getQueryParam('ovr');
            if (ovrParam === 'NULL') return [{ name: 'NULL', y: 100 }];

            function translateSource(source) {
                if (source.startsWith('firewallCustom')) return 'Custom Rules';
                if (source.startsWith('m')) return 'Managed Ruleset';
                if (source.startsWith('s')) return 'Security Level';
                if (source.startsWith('r')) return 'Rate Limit';
                if (source.startsWith('l7')) return 'HTTP DDoS';
                if (source.startsWith('bic')) return 'Browser Integrity Check';
                if (source.startsWith('botFight')) return 'Bot Fight Mode';
                if (source.startsWith('firewallManaged')) return 'Managed Rules';
                if (source.startsWith('pass')) return 'Successful';
                return source;
            }

            const sources = ovrParam.slice(1, -1).split(',');
            return sources.map(source => {
                const [sourceKey, value] = source.split('-');
                return { name: translateSource(sourceKey), y: parseFloat(value) };
            });
        }

        function getNationData() {
            const nationParam = getQueryParam('nation');
            if (nationParam === 'NULL') return [{ name: 'NULL', y: 100 }];

            const nationCodes = nationParam.slice(1, -1).split(',');
            const promises = nationCodes.map(async code => {
                const [countryCode, count] = code.split('-');
                try {
                    const response = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`);
                    const data = await response.json();
                    const countryName = data[0].name.common;
                    return { name: countryName || countryCode, y: parseFloat(count) };
                } catch {
                    return { name: countryCode, y: parseFloat(count) };
                }
            });

            return Promise.all(promises).then(results => {
                results.sort((a, b) => b.y - a.y);
                return results;
            }).catch(() => [{ name: 'NULL', y: 100 }]);
        }

        // Update dynamic text
        document.getElementById('right-text').textContent = getQueryParam('sv');
        document.getElementById('date-text').textContent = getQueryParam('date');
        document.getElementById('profile-name').textContent = getQueryParam('name');
        document.getElementById('profile-username').textContent = "@" + getQueryParam('user');
        document.getElementById('telegram-uid').textContent = getQueryParam('uid');
        document.getElementById('total-requests').textContent = getQueryParam('total');

        // Update progress bar
        const allowed = parseFloat(getQueryParam('allow') || '100');
        const bypass = parseFloat(getQueryParam('bypass') || '0');
        const block = parseFloat(getQueryParam('block') || '0');
        document.getElementById('progress-allowed').style.width = `${allowed}%`;

        // Charts
        Highcharts.chart('container-pie', {
            chart: { type: 'pie', backgroundColor: 'transparent', height: 295, width: 240 },
            title: { text: 'Overall' },
            tooltip: { pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>' },
            legend: { enabled: true },
            plotOptions: {
                pie: { dataLabels: { enabled: false }, borderWidth: 2 },
                series: { animation: false, showInLegend: true }
            },
            series: [{ name: 'Source', colorByPoint: true, data: getSeriesData() }],
            credits: { enabled: false }
        });

        getNationData().then(data => {
            Highcharts.chart('container-bar', {
                chart: { type: 'bar', backgroundColor: 'transparent' },
                title: { text: "Top Nation's IP" },
                xAxis: {
                    categories: data.map(d => d.name),
                    labels: { formatter: function () {
                        return this.value.length > 16 ? this.value.substring(0, 8) + 'â€¦' : this.value;
                    }}
                },
                yAxis: { min: 0, gridLineDashStyle: 'Dash' },
                tooltip: { valueSuffix: ' counts' },
                plotOptions: {
                    bar: {
                        dataLabels: { enabled: true, format: '{y}' },
                        color: '#62C7F8',
                        animation: false
                    }
                },
                legend: { enabled: false },
                series: [{ name: 'Count', data: data.map(d => d.y) }],
                credits: { enabled: false }
            });
        });

        updateTable();
    </script>
</body>
</html>
