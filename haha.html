<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Statistics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-6">

    <!-- Profile Card -->
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-2xl p-4 mb-6 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="w-14 h-14 bg-gray-300 rounded-full flex items-center justify-center text-xl text-white">
                <span>ðŸ‘¤</span>
            </div>
            <div>
                <h2 class="font-bold text-lg" id="profile-name">NULL</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400" id="profile-username">@NULL</p>
            </div>
        </div>
        <div class="text-sm text-gray-600 dark:text-gray-300">
            <span>Telegram UID: </span><span id="telegram-uid">NULL</span>
        </div>
    </div>

    <!-- Server Info -->
    <div class="mb-6 flex justify-between">
        <span class="text-lg font-semibold">Server: <span id="right-text">NULL</span></span>
        <span class="text-lg font-semibold">Date: <span id="date-text">NULL</span></span>
    </div>

    <!-- Chart Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
            <div id="container-pie" class="w-full h-72"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
            <div id="container-bar" class="w-full h-72"></div>
        </div>
    </div>

    <!-- Tables -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <table id="table-1" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">ISP</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">Count</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600"></tbody>
        </table>

        <table id="table-2" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">ISP</th>
                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">Count</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600"></tbody>
        </table>
    </div>

    <script>
        async function loadASNData() {
            try {
                const response = await fetch('asn_data.json');
                return await response.json();
            } catch (error) {
                console.error('Error loading ASN data:', error);
                return [];
            }
        }

        async function getISPName(asnCode, asnData) {
            const entry = asnData.find(item => item.ASN === `AS${asnCode}`);
            return entry ? entry["AS Name"] : 'Unknown ISP';
        }

        function formatCount(count) {
            if (count >= 1e9) return (count / 1e9).toFixed(1) + 'B';
            if (count >= 1e6) return (count / 1e6).toFixed(1) + 'M';
            if (count >= 1e3) return (count / 1e3).toFixed(1) + 'K';
            return count;
        }

        async function updateTableAndTotal() {
            const params = new URLSearchParams(window.location.search);
            const asnRaw = params.get('asn');
            const asnList = asnRaw ? asnRaw.slice(1, -1).split(',') : ['AS0000-0'];
            const asnData = await loadASNData();

            const rows = await Promise.all(asnList.map(async entry => {
                const [asn, countStr] = entry.split('-');
                const count = parseFloat(countStr);
                const name = await getISPName(asn, asnData);
                return { name, count, formattedCount: formatCount(count) };
            }));

            rows.sort((a, b) => b.count - a.count);

            const maxRows = 10;
            while (rows.length < maxRows) {
                rows.push({ name: '?', count: 0, formattedCount: '?' });
            }

            const tables = [document.querySelector('#table-1 tbody'), document.querySelector('#table-2 tbody')];
            rows.forEach((row, i) => {
                const table = tables[Math.floor(i / 5)];
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-4 py-2">${i + 1}</td><td class="px-4 py-2">${row.name}</td><td class="px-4 py-2">${row.formattedCount}</td>`;
                table.appendChild(tr);
            });
        }

        function getQueryParam(key) {
            const params = new URLSearchParams(window.location.search);
            return params.get(key) || 'NULL';
        }

        function getPieData() {
            const param = getQueryParam('ovr');
            if (param === 'NULL') return [{ name: 'NULL', y: 100 }];
            const map = {
                firewallCustom: 'Custom Rules',
                m: 'Managed Ruleset',
                s: 'Security Level',
                r: 'Rate Limit',
                l7: 'HTTP DDoS',
                bic: 'Browser Integrity Check',
                botFight: 'Bot Fight Mode',
                firewallManaged: 'Managed Rules',
                pass: 'Successful'
            };
            return param.slice(1, -1).split(',').map(entry => {
                const [key, value] = entry.split('-');
                return { name: map[key] || key, y: parseFloat(value) };
            });
        }

        async function getNationData() {
            const param = getQueryParam('nation');
            if (param === 'NULL') return [{ name: 'NULL', y: 100 }];
            const list = param.slice(1, -1).split(',');
            const data = await Promise.all(list.map(async entry => {
                const [code, count] = entry.split('-');
                try {
                    const res = await fetch(`https://restcountries.com/v3.1/alpha/${code}`);
                    const json = await res.json();
                    return { name: json[0].name.common, y: parseFloat(count) };
                } catch {
                    return { name: code, y: parseFloat(count) };
                }
            }));
            return data.sort((a, b) => b.y - a.y);
        }

        document.getElementById('right-text').textContent = getQueryParam('sv');
        document.getElementById('date-text').textContent = getQueryParam('date');
        document.getElementById('profile-name').textContent = getQueryParam('name');
        document.getElementById('profile-username').textContent = "@" + getQueryParam('user');
        document.getElementById('telegram-uid').textContent = getQueryParam('uid');

        Highcharts.chart('container-pie', {
            chart: { type: 'pie', backgroundColor: 'transparent' },
            title: { text: 'Overall' },
            series: [{ name: 'Source', colorByPoint: true, data: getPieData() }],
            tooltip: { pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>' },
            plotOptions: {
                pie: { dataLabels: { enabled: false }, borderWidth: 2 },
                series: { animation: false, showInLegend: true }
            },
            credits: { enabled: false }
        });

        getNationData().then(data => {
            Highcharts.chart('container-bar', {
                chart: { type: 'bar', backgroundColor: 'transparent' },
                title: { text: "Top Nation's IP" },
                xAxis: {
                    categories: data.map(d => d.name),
                    labels: {
                        formatter: function () {
                            return this.value.length > 16 ? this.value.substring(0, 8) + 'â€¦' : this.value;
                        }
                    }
                },
                yAxis: { min: 0, gridLineDashStyle: 'Dash' },
                tooltip: { valueSuffix: ' counts' },
                plotOptions: {
                    bar: {
                        dataLabels: { enabled: true, format: '{y}' },
                        color: '#62C7F8',
                        animation: false
                    }
                },
                legend: { enabled: false },
                series: [{ name: 'Count', data: data.map(d => d.y) }],
                credits: { enabled: false }
            });
        });

        updateTableAndTotal();
    </script>
</body>
</html>
