<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloudflare Statistics</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #f4f7fa, #e3ecf5);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .dashboard {
      width: 100%;
      max-width: 1200px;
      padding: 30px;
      box-sizing: border-box;
    }

    #top-container {
      background: #fff;
      padding: 15px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .highlight-box {
      background-color: #fef3c7;
      padding: 6px 16px;
      border-radius: 999px;
      color: #b45309;
      font-weight: 600;
    }

    .charts-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-box {
      background: #ffffffcc;
      border-radius: 12px;
      padding: 20px;
      flex: 1;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    #container-table {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    table {
      border-collapse: collapse;
      width: 50%;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
    }

    th {
      background-color: #f3f4f6;
      font-weight: 600;
    }

    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }
  </style>
</head>
<body>
<div class="dashboard">
  <div id="top-container">
    <span>DSTAT EUIS</span>
    <span class="highlight-box">Premium Statistics</span>
    <span id="right-text">Cloudflare-Pro</span>
    <span id="date-text">--/--/----</span>
  </div>

  <div class="charts-container">
    <div class="chart-box" id="container-pie"></div>
    <div class="chart-box" id="container-bar"></div>
  </div>

  <div id="container-table">
    <table id="table-1">
      <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
      <tbody></tbody>
    </table>
    <table id="table-2">
      <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  async function loadASNData() {
    try {
      const response = await fetch('asn_data.json');
      return await response.json();
    } catch (err) {
      console.error('ASN Data load failed:', err);
      return [];
    }
  }

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param) || 'NULL';
  }

  function formatCount(count) {
    if (count >= 1e9) return (count / 1e9).toFixed(1) + 'B';
    if (count >= 1e6) return (count / 1e6).toFixed(1) + 'M';
    if (count >= 1e3) return (count / 1e3).toFixed(1) + 'K';
    return count;
  }

  async function getISPName(asnCode, asnData) {
    const entry = asnData.find(e => e.ASN === `AS${asnCode}`);
    return entry ? entry['AS Name'] : 'Unknown ISP';
  }

  async function updateTable() {
    const asnParam = getQueryParam('asn');
    const asnEntries = asnParam !== 'NULL' ? asnParam.slice(1, -1).split(',') : [];
    const asnData = await loadASNData();

    const tableData = await Promise.all(asnEntries.map(async entry => {
      const [code, countStr] = entry.split('-');
      return {
        name: await getISPName(code, asnData),
        count: parseFloat(countStr),
        formattedCount: formatCount(parseFloat(countStr))
      };
    }));

    while (tableData.length < 10) {
      tableData.push({ name: '?', count: 0, formattedCount: '?' });
    }

    tableData.sort((a, b) => b.count - a.count);

    [document.querySelector('#table-1 tbody'), document.querySelector('#table-2 tbody')].forEach(t => t.innerHTML = '');

    tableData.forEach((item, i) => {
      const row = `<tr><td>${i + 1}</td><td>${item.name}</td><td>${item.formattedCount}</td></tr>`;
      const table = i < 5 ? '#table-1' : '#table-2';
      document.querySelector(`${table} tbody`).innerHTML += row;
    });
  }

  function getSeriesData() {
    const ovr = getQueryParam('ovr');
    if (ovr === 'NULL') return [{ name: 'NULL', y: 100 }];

    function translate(source) {
      const map = {
        firewallCustom: 'Custom Rules', m: 'Managed Ruleset', s: 'Security Level',
        r: 'Rate Limit', l7: 'HTTP DDoS', bic: 'Browser Integrity',
        botFight: 'Bot Fight Mode', firewallManaged: 'Managed Rules', pass: 'Successful'
      };
      for (const key in map) if (source.startsWith(key)) return map[key];
      return source;
    }

    return ovr.slice(1, -1).split(',').map(s => {
      const [key, val] = s.split('-');
      return { name: translate(key), y: parseFloat(val) };
    });
  }

  async function getNationData() {
    const nation = getQueryParam('nation');
    if (nation === 'NULL') return [{ name: 'NULL', y: 100 }];

    const entries = nation.slice(1, -1).split(',');
    const promises = entries.map(async entry => {
      const [code, count] = entry.split('-');
      try {
        const res = await fetch(`https://restcountries.com/v3.1/alpha/${code}`);
        const json = await res.json();
        return { name: json[0].name.common, y: parseFloat(count) };
      } catch {
        return { name: code, y: parseFloat(count) };
      }
    });

    const data = await Promise.all(promises);
    return data.sort((a, b) => b.y - a.y);
  }

  document.getElementById('right-text').textContent = getQueryParam('sv');
  document.getElementById('date-text').textContent = getQueryParam('date');

  Highcharts.setOptions({
    colors: ['#60A5FA', '#FBBF24', '#34D399', '#F472B6', '#A78BFA', '#F87171', '#818CF8']
  });

  Highcharts.chart('container-pie', {
    chart: { type: 'pie', backgroundColor: 'transparent' },
    title: { text: 'Overall Sources', style: { fontWeight: '600' } },
    plotOptions: {
      pie: { allowPointSelect: true, cursor: 'pointer', dataLabels: { enabled: false }, showInLegend: true }
    },
    tooltip: { pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>' },
    series: [{ name: 'Source', colorByPoint: true, data: getSeriesData() }],
    credits: { enabled: false }
  });

  getNationData().then(data => {
    Highcharts.chart('container-bar', {
      chart: { type: 'bar', backgroundColor: 'transparent' },
      title: { text: "Top Nation's IP" },
      xAxis: {
        categories: data.map(d => d.name),
        labels: {
          formatter: function () {
            return this.value.length > 16 ? this.value.substring(0, 8) + 'â€¦' : this.value;
          }
        }
      },
      yAxis: { min: 0, title: null, gridLineDashStyle: 'Dash' },
      tooltip: { valueSuffix: ' counts' },
      plotOptions: {
        bar: {
          dataLabels: { enabled: true, format: '{y}', style: { fontWeight: '500' } },
          borderRadius: 3
        }
      },
      legend: { enabled: false },
      series: [{ name: 'Count', data: data.map(d => d.y) }],
      credits: { enabled: false }
    });
  });

  updateTable();
</script>
</body>
</html>
