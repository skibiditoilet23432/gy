<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cloudflare Statistics (Dark Mode)</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap');

    :root {
      --bg-color: #111827;
      --card-color: #1F2937;
      --text-color: #F9FAFB;
      --highlight: #FACC15;
      --accent: #3B82F6;
      --box-shadow: rgba(0, 0, 0, 0.5);
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      font-family: 'Courier Prime', monospace;
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .highcharts-figure {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: calc(100vh - 100px);
      gap: 20px;
    }

    #top-container {
      width: 960px;
      height: 50px;
      background-color: var(--card-color);
      border-radius: 12px;
      box-shadow: 0 0 10px var(--box-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      font-weight: bold;
    }

    #top-container p {
      margin: 0;
      flex: 1;
      text-align: center;
    }

    .highlight-box {
      background-color: var(--highlight);
      color: #1F2937;
      border-radius: 9999px;
      padding: 4px 16px;
      font-weight: bold;
    }

    #container-pie, #container-bar {
      background-color: var(--card-color);
      border-radius: 12px;
      box-shadow: 0 0 10px var(--box-shadow);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #container-pie {
      width: 320px;
      height: 320px;
    }

    #container-bar {
      width: 600px;
      height: 320px;
    }

    #container-table {
      width: 920px;
      background-color: var(--card-color);
      border-radius: 12px;
      box-shadow: 0 0 10px var(--box-shadow);
      display: flex;
      justify-content: space-around;
      padding: 20px;
    }

    table {
      border-collapse: collapse;
      width: 45%;
      color: var(--text-color);
    }

    th, td {
      border: 1px dashed #374151;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #1E293B;
    }

    tbody tr:nth-child(even) {
      background-color: #111827;
    }
  </style>
</head>
<body>
  <figure class="highcharts-figure">
    <div id="top-container">
      <p style="text-align: left;">DSTAT EUIS</p>
      <p class="highlight-box">Premium Statistics</p>
      <p id="right-text">Cloudflare-Pro</p>
      <p id="date-text" style="text-align: right;">18/8/2024</p>
    </div>
    <div style="display: flex; gap: 20px;">
      <div id="container-pie"></div>
      <div id="container-bar"></div>
    </div>
    <div id="container-table">
      <table id="table-1">
        <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
      <table id="table-2">
        <thead><tr><th>#</th><th>ASN</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </figure>

  <script>
    const params = new URLSearchParams(window.location.search);
    const getParam = key => params.get(key) || 'NULL';

    document.getElementById('right-text').textContent = getParam('sv');
    document.getElementById('date-text').textContent = getParam('date');

    async function loadASNData() {
      try {
        const res = await fetch('asn_data.json');
        return await res.json();
      } catch {
        return [];
      }
    }

    async function updateTable() {
      const asnDataParam = getParam('asn');
      const items = asnDataParam === 'NULL' ? ['AS0000-0'] : asnDataParam.slice(1, -1).split(',');
      const asnData = await loadASNData();
      const formatCount = c => c >= 1e6 ? (c / 1e6).toFixed(1) + 'M' : c >= 1e3 ? (c / 1e3).toFixed(1) + 'K' : c;

      const tableData = await Promise.all(items.map(async i => {
        const [asn, countStr] = i.split('-');
        const found = asnData.find(e => e.ASN === `AS${asn}`);
        return {
          name: found ? found['AS Name'] : 'Unknown',
          count: +countStr,
          formattedCount: formatCount(+countStr)
        };
      }));

      while (tableData.length < 10) tableData.push({ name: '?', count: 0, formattedCount: '?' });
      tableData.sort((a, b) => b.count - a.count);

      const tables = [document.querySelector('#table-1 tbody'), document.querySelector('#table-2 tbody')];
      tableData.forEach((item, i) => {
        const row = `<tr><td>${i + 1}</td><td>${item.name}</td><td>${item.formattedCount}</td></tr>`;
        tables[Math.floor(i / 5)].insertAdjacentHTML('beforeend', row);
      });
    }

    function getSeriesData() {
      const ovrParam = getParam('ovr');
      if (ovrParam === 'NULL') return [{ name: 'NULL', y: 100 }];
      const map = {
        firewallCustom: 'Custom Rules',
        m: 'Managed Ruleset',
        s: 'Security Level',
        r: 'Rate Limit',
        l7: 'HTTP DDoS',
        bic: 'Browser Integrity Check',
        botFight: 'Bot Fight Mode',
        firewallManaged: 'Managed Rules',
        pass: 'Successful'
      };
      return ovrParam.slice(1, -1).split(',').map(s => {
        const [key, val] = s.split('-');
        return { name: map[key] || key, y: parseFloat(val) };
      });
    }

    async function getNationData() {
      const nationParam = getParam('nation');
      if (nationParam === 'NULL') return [{ name: 'NULL', y: 100 }];
      const codes = nationParam.slice(1, -1).split(',');
      return await Promise.all(codes.map(async (c) => {
        const [cc, cnt] = c.split('-');
        try {
          const res = await fetch(`https://restcountries.com/v3.1/alpha/${cc}`);
          const data = await res.json();
          return { name: data[0].name.common, y: +cnt };
        } catch {
          return { name: cc, y: +cnt };
        }
      })).then(res => res.sort((a, b) => b.y - a.y));
    }

    Highcharts.setOptions({
      chart: {
        backgroundColor: 'transparent',
        style: { fontFamily: 'Courier Prime, monospace' }
      },
      title: { style: { color: '#F9FAFB' } },
      xAxis: { labels: { style: { color: '#F9FAFB' } } },
      yAxis: { labels: { style: { color: '#F9FAFB' } } },
      legend: { itemStyle: { color: '#F9FAFB' } },
      tooltip: { style: { color: '#F9FAFB' } }
    });

    Highcharts.chart('container-pie', {
      chart: { type: 'pie', height: 290, width: 260 },
      title: { text: 'Overall' },
      plotOptions: {
        pie: {
          dataLabels: { enabled: false },
          borderColor: '#111827',
          borderWidth: 2
        }
      },
      series: [{ name: 'Source', colorByPoint: true, data: getSeriesData() }],
      credits: { enabled: false }
    });

    getNationData().then(data => {
      Highcharts.chart('container-bar', {
        chart: { type: 'bar' },
        title: { text: "Top Nation's IP" },
        xAxis: {
          categories: data.map(d => d.name),
          labels: {
            formatter() {
              return this.value.length > 16 ? this.value.slice(0, 8) + 'â€¦' : this.value;
            }
          }
        },
        yAxis: { min: 0 },
        plotOptions: {
          bar: {
            dataLabels: {
              enabled: true,
              style: { color: '#FACC15', fontWeight: 'bold' }
            },
            color: '#3B82F6'
          }
        },
        legend: { enabled: false },
        series: [{ name: 'Count', data: data.map(d => d.y) }],
        credits: { enabled: false }
      });
    });

    updateTable();
  </script>
</body>
</html>
